[4.5 Regression] cancel_loop_tree: bad read causes ice

 http://gcc.gnu.org/bugzilla/show_bug.cgi?id=42229

--- trunk/gcc/ChangeLog	2009/12/02 14:49:11	154913
+++ trunk/gcc/ChangeLog	2009/12/02 15:22:01	154914
@@ -384,6 +384,14 @@
 	(iorsi3): Likewise.
 	* config/pa/pa-protos.h (ior_operand): Delete declarations.
 
+2011-04-21  Richard Guenther  <rguenther@suse.de>
+	Backported from mainline
+	2009-12-02  Richard Guenther  <rguenther@suse.de>
+
+	PR middle-end/42229
+	* cfgloopmanip.c (remove_path): Avoid cancelling loops
+	twice.
+
 2011-04-19  John David Anglin  <dave.anglin@nrc-cnrc.gc.ca>
 
 	* config/pa/pa.h (REGISTER_MOVE_COST): Increase to 18 cost of
--- trunk/gcc/cfgloopmanip.c	2009/12/02 14:49:11	154913
+++ trunk/gcc/cfgloopmanip.c	2009/12/02 15:22:01	154914
@@ -279,10 +279,9 @@
   edge ae;
   basic_block *rem_bbs, *bord_bbs, from, bb;
   VEC (basic_block, heap) *dom_bbs;
-  int i, nrem, n_bord_bbs, nreml;
+  int i, nrem, n_bord_bbs;
   sbitmap seen;
   bool irred_invalidated = false;
-  struct loop **deleted_loop;
 
   if (!can_remove_branch_p (e))
     return false;
@@ -343,15 +342,9 @@
   dom_bbs = NULL;
 
   /* Cancel loops contained in the path.  */
-  deleted_loop = XNEWVEC (struct loop *, nrem);
-  nreml = 0;
   for (i = 0; i < nrem; i++)
     if (rem_bbs[i]->loop_father->header == rem_bbs[i])
-      deleted_loop[nreml++] = rem_bbs[i]->loop_father;
-
-  for (i = 0; i < nreml; i++)
-    cancel_loop_tree (deleted_loop[i]);
-  free (deleted_loop);
+      cancel_loop_tree (rem_bbs[i]->loop_father);
 
   remove_bbs (rem_bbs, nrem);
   free (rem_bbs);
